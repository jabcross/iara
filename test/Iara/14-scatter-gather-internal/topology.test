// RUN: export SCHEDULER_MODE=$SCHEDULER_MODE
// RUN: pwd >&2
// RUN: build-single-test.sh .
// RUN: pwd >&2
// RUN: ls build >&2
// RUN: ./build/a.out > ./build/output.txt
// RUN: FileCheck %s < ./build/output.txt

// Test scatter/gather with internally managed memory (allocated by runtime)

iara.actor @run {
  %full = iara.node @produce out (tensor<8xi32>)
  %a, %b, %c, %d = iara.node @__iara_scatter__
    in (%full : tensor<8xi32>)
    out (tensor<2xi32>, tensor<2xi32>, tensor<2xi32>, tensor<2xi32>)
  %a2 = iara.node @process_a inout (%a : tensor<2xi32>) out (tensor<2xi32>)
  %b2 = iara.node @process_b inout (%b : tensor<2xi32>) out (tensor<2xi32>)
  %c2 = iara.node @process_c inout (%c : tensor<2xi32>) out (tensor<2xi32>)
  %d2 = iara.node @process_d inout (%d : tensor<2xi32>) out (tensor<2xi32>)
  %result = iara.node @__iara_gather__
    in (%a2 : tensor<2xi32>, %b2 : tensor<2xi32>, %c2 : tensor<2xi32>, %d2 : tensor<2xi32>)
    out (tensor<8xi32>)
  iara.node @consume in (%result : tensor<8xi32>)
}

// CHECK: Produced: [0, 1, 2, 3, 4, 5, 6, 7]
// CHECK: Process A: [0, 1]
// CHECK: Process B: [2, 3]
// CHECK: Process C: [4, 5]
// CHECK: Process D: [6, 7]
// CHECK: Consumed: [1, 2, 3, 4, 5, 6, 7, 8]
